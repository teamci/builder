#!/usr/bin/env bash

set -euo pipefail

run_check() {
	if [ -z "${TEAMCI_CHECK_IMAGE:-}" ]; then
		echo "FATAL: Internal error. TEAMCI_CHECK_IMAGE missing. Please contact support."
		return 7
	fi

	get_access_token
	sync_code

	echo "~~~ Running check"

	local check_exit_code

	set +e
	docker run --rm \
		-v "${CODE_DIR}:/data/code:ro" \
		-v "${PWD}/logs/tap.log:/data/logs/tap.log" \
		--cpus 1 \
		--memory 512m \
		"${TEAMCI_CHECK_IMAGE}" 2>&1 | tee logs/execution.log
	check_exit_code=$?
	set -e

	return "${check_exit_code}"
}

main() {
	mkdir -p logs

	source .buildkite/hooks/pre-check

	run_check 2>&1 > tee -a logs/check.log
}

main "$@"
