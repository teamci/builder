#!/usr/bin/env bash

set -euo pipefail

main() {
	source .buildkite/hooks/pre-check

	if [ -z "${TEAMCI_CHECK_NAME:-}" ]; then
		echo "FATAL: Internal error. TEAMCI_CHECK_NAME missing. Please contact support."
		return 7
	fi

	if [ -z "${TEAMCI_CHECK_IMAGE:-}" ]; then
		echo "FATAL: Internal error. TEAMCI_CHECK_IMAGE missing. Please contact support."
		return 7
	fi

	if [ -z "${TEAMCI_CHECK_TITLE:-}" ]; then
		echo "FATAL: Internal error. TEAMCI_CHECK_TITLE missing. Please contact support."
		return 7
	fi

	if [ -z "${TEAMCI_CHECK_OUTPUT:-}" ]; then
		echo "FATAL: Internal error. TEAMCI_CHECK_OUTPUT missing. Please contact support."
		return 7
	fi

	mkdir -p logs

	get_access_token
	sync_code
	sync_config

	buildkite-agent meta-data set \
		"teamci.${TEAMCI_CHECK_NAME}.title" \
		"${TEAMCI_CHECK_TITLE}"

	echo "~~~ Running check"

	local check_exit_code

	touch logs/tap.log

	set +e
	docker run --rm \
		-v "${CODE_DIR}:/data/code:ro" \
		-v "${CONFIG_DIR}:/data/config:ro" \
		-v "${PWD}/logs/tap.log:/data/logs/tap.log" \
		-e "TEAMCI_TAP_LOG_OUTPUT=/data/logs/tap.log" \
		--cpus 1 \
		--memory 512m \
		"${TEAMCI_CHECK_IMAGE}" 2>&1 | tee "logs/${TEAMCI_CHECK_NAME}".log
	check_exit_code=$?
	set -e

	return "${check_exit_code}"
}

main "$@"
